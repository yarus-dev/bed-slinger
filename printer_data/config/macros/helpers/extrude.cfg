[gcode_macro EXTRUDE]
gcode:
  {% if printer.extruder.can_extrude|lower != 'true' %}
    RESPOND TYPE=error MSG="Extruder not hot enough"
  {% else %}
    SAVE_GCODE_STATE NAME=extrude
    {% set length = params.LENGTH|default(0)|float %}
    {% set feedrate = params.SPEED|default(printer.firmware_retraction.retract_speed)|int * 60 %}
    M83 ;Relative extrusion
    G1 E{length} F{feedrate}
    RESTORE_GCODE_STATE NAME=extrude
  {% endif %}

[gcode_macro RETRACT]
gcode:
  SAVE_GCODE_STATE NAME=retract
  {% set length = params.LENGTH|default(printer.firmware_retraction.retract_length)|float * -1 %}
  {% set speed = params.SPEED|default(printer.firmware_retraction.retract_speed)|int %}
    M83 ;Relative extrusion
    G91 ;Relative positioning

    EXTRUDE LENGTH={length} SPEED={speed}
    G1 Z0.2 F2400 ;Raise Z
    G1 E-2 F300 ;Retract filament 2mm to prevent oozing
  
  RESTORE_GCODE_STATE NAME=retract

[gcode_macro UNRETRACT]
gcode:
    G11
