[gcode_macro EXTRUDE]
gcode:
    G10

[gcode_macro RETRACT]
gcode:
    {% set vars = printer.save_variables.variables %}

    {% set FEEDRATE =  params.FEEDRATE|default(vars.retract_speed)|float|abs %}
    {% set amount = params.AMOUNT|default(vars.retract_amount)|float|abs %}
    {% set amount_start = (amount * 0.38)|round(3) %}
    {% set amount_finish = (amount - amount_start)|round(3) %}
    {% set z_hop = params.Z_HOP|default(vars.retract_z_hop)|default(0.2)|float|round(2) %}

    EXTRUDE LENGTH={amount_start * -1} FEEDRATE={FEEDRATE}
    EXTRUDE LENGTH={amount_finish * -1} z_hop={z_hop} FEEDRATE={FEEDRATE}
    SAVE_VARIABLE variable=retracted VALUE={(vars.retracted|default(0) + amount_start + amount_finish)|float|round(3)}

[gcode_macro UNRETRACT]
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set length = params.LENGTH|default(vars.retracted)|float|abs%}
    {% set feedrate = params.FEEDRATE|default(vars.unretract_speed)|float|abs * 60%}
    EXTRUDE LENGTH={length} FEEDRATE={feedrate}
    SAVE_VARIABLE variable=retracted VALUE={(vars.retracted - length)|float}
