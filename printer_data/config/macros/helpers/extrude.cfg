[gcode_macro EXTRUDE]
gcode:
    _LOW_TEMP_CHECK
    {% set act       = printer.gcode_move.gcode_position %}
    {% set is_absolute_coordinates = printer.gcode_move.absolute_coordinates %}
    {% set is_absolute_extrude = printer.gcode_move.absolute_extrude %}

    {% set length = params.LENGTH|default(0)|float %}
    {% set feedrate = params.FEEDRATE|default(10)|float * 60%}
    {% set z_hop = params.Z_HOP|default(0)|float %}
    M83
    G90
    {% if z_hop > 0 %}
        G17
        G2 Z{act.z + z_hop} I{z_hop*1.618|round(2)} J{z_hop*1.618|round(2)} E{length} F{feedrate}
    {% else %}
        G1 E{length} F{feedrate}
    {% endif %}
    {% if is_absolute_extrude %}
        M82
    {% endif %}
    {% if not is_absolute_coordinates %}
        G91
    {% endif %}

[gcode_macro RETRACT]
gcode:
    {% set vars = printer.save_variables.variables %}

    {% set FEEDRATE =  params.FEEDRATE|default(vars.retract_speed)|float|abs %}
    {% set amount = params.AMOUNT|default(vars.retract_amount)|float|abs %}
    {% set amount_start = (amount * 0.38)|round(3) %}
    {% set amount_finish = (amount - amount_start)|round(3) %}
    {% set z_hop = params.Z_HOP|default(vars.retract_z_hop)|default(0.2)|float|round(2) %}

    EXTRUDE LENGTH={amount_start * -1} FEEDRATE={FEEDRATE}
    EXTRUDE LENGTH={amount_finish * -1} z_hop={z_hop} FEEDRATE={FEEDRATE}
    SAVE_VARIABLE variable=retracted VALUE={(vars.retracted|default(0) + amount_start + amount_finish)|float|round(3)}

[gcode_macro UNRETRACT]
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set length = params.LENGTH|default(vars.retracted)|float|abs%}
    {% set feedrate = params.FEEDRATE|default(vars.unretract_speed)|float|abs * 60%}
    EXTRUDE LENGTH={length} FEEDRATE={feedrate}
    SAVE_VARIABLE variable=retracted VALUE={(vars.retracted - length)|float}
