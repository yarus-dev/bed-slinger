[gcode_macro EXTRUDE]
gcode:
  {% if printer.extruder.can_extrude|lower != 'true' %}
    RESPOND TYPE=error MSG="Extruder not hot enough"
  {% else %}
    SAVE_GCODE_STATE NAME=safe_retract
    {% set length = params.LENGTH|default(0)|float %}
    {% set feedrate = params.SPEED|default(printer.firmware_retraction.retract_speed)|int * 60 %}
    M83 ;Relative extrusion
    G1 E{length} F{feedrate}
  {% endif %}

[gcode_macro RETRACT]
gcode:
  {% set length = params.LENGTH|default(printer.firmware_retraction.retract_length)|float %}
  {% set feedrate = params.SPEED|default(printer.firmware_retraction.retract_speed)|int * 60 %}
      M83 ;Relative extrusion
    G91 ;Relative positioning

    G10 ;Retract filament
    G1 Z0.2 F2400 ;Raise Z
    G1 E-2 F300 ;Retract filament 2mm to prevent oozing
  EXTRUDE 

[gcode_macro UNRETRACT]
gcode:
    G11
