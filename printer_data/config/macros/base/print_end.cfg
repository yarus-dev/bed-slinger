[gcode_macro _PRINT_END]
description: ending script
gcode:
  {% set vars = printer.save_variables.variables %}
  G91 ;Relative positionning 
  G1 X-2 Y-2 E-3 F{}

  G1 E-{vars.tip*0.318|float} F2700 ;Retract a bit 
  G1 E-{vars.tip*(1 - 0.318)|float} Z0.2 F2400 ;Retract and raise Z 
  G1 X5 Y5 F3000 ;Wipe out 
  STEP_ASIDE_SON
  G90 ;Absolute positionning 

  _RESET_CONTEXT

  BED_MESH_CLEAR
  _TIMELAPSE_END
  {% if 'virtual_sdcard' in printer and not printer.virtual_sdcard.is_active %}SDCARD_RESET_FILE{% endif %}
  
  M84 X E ;Disable all steppers but Z

  BEEP
  BEEP
  RESPOND MSG="Print finished, Master Yar."